# Lockplane

Easy postgres schema management.

[![Test](https://github.com/lockplane/lockplane/actions/workflows/test.yml/badge.svg)](https://github.com/lockplane/lockplane/actions/workflows/test.yml)
[![codecov](https://codecov.io/github/lockplane/lockplane/graph/badge.svg?token=JP0QINP1G1)](https://codecov.io/github/lockplane/lockplane)

## 1. Install

```bash
go install github.com/lockplane/lockplane
```

## 2. Create a config file

The config file is a TOML file named `lockplane.toml` in the root of the project.  It should look like this:

```toml
[environments.local]
postgres_url = "postgresql://postgres:postgres@localhost:5432/postgres"
```

At this time, only a single environment called `local` is supported.

## 3. Create a schema file

Add to `schema/users.lp.sql`:

```sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY,
  email TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

For now, schema files must be in the root of the `schema/` directory, and must
end in `.lp.sql`.

## 4. Check the schema for issues

```bash
# TODO
npx lockplane check-schema
```

## 4. Apply changes

```bash
# TODO
npx lockplane apply
```

## Postgres Feature Support

Feature | SQL Parsing | DB Introspection
-- | -- | --
CREATE TABLE | ✅ | ✅
Column types: SMALLINT, INTEGER, BIGINT, SMALLSERIAL, SERIAL, BIGSERIAL TIMESTAMP, VARCHAR, CHAR, REAL, DOUBLE PRECISION, TIMESTAMP [WITH TIME ZONE], TIME [WITH TIME ZONE], TEXT, NUMERIC, DECIMAL, BYTEA, JSON, JSONB | ✅ | ✅
ENABLE/DISABLE ROW LEVEL SECURITY | ✅ | ✅
## TODO: ALTER COLUMN Migration Patterns

PostgreSQL has several scenarios where `ALTER COLUMN` requires special handling beyond a simple type change. Understanding these cases is critical for safe migrations.

### 1. SERIAL/BIGSERIAL/SMALLSERIAL (Pseudo-Types)

**Problem:** `SERIAL` types only work in `CREATE TABLE`. They're shorthand for creating an integer column with a sequence.

❌ **Invalid:**
```sql
ALTER TABLE t ALTER COLUMN id TYPE bigserial;
```

✅ **Correct:**
```sql
-- Change type to the underlying integer type
ALTER TABLE t ALTER COLUMN id TYPE bigint;

-- Create and attach a sequence
CREATE SEQUENCE t_id_seq;
ALTER TABLE t ALTER COLUMN id SET DEFAULT nextval('t_id_seq');
ALTER SEQUENCE t_id_seq OWNED BY t.id;

-- Set sequence to current max value
SELECT setval('t_id_seq', COALESCE((SELECT MAX(id) FROM t), 1), false);
```

### 2. IDENTITY Columns

IDENTITY is orthogonal to type - handle separately.

```sql
-- Adding identity
ALTER TABLE t ALTER COLUMN id DROP DEFAULT;  -- Remove any existing default
ALTER TABLE t ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY;

-- Removing identity
ALTER TABLE t ALTER COLUMN id DROP IDENTITY;
```

### 3. Array Type Conversions

Requires `USING` clause with data transformation.

```sql
-- text → text[]
ALTER TABLE t ALTER COLUMN tags TYPE text[] USING ARRAY[tags];

-- text[] → text
ALTER TABLE t ALTER COLUMN tags TYPE text USING array_to_string(tags, ',');
```

### 4. Type Changes Requiring USING

When implicit casts don't exist:

```sql
-- text → integer
ALTER TABLE t ALTER COLUMN val TYPE integer USING val::integer;

-- timestamp → date (loses time component)
ALTER TABLE t ALTER COLUMN created TYPE date USING created::date;

-- Numeric precision changes
ALTER TABLE t ALTER COLUMN price TYPE numeric(10,2) USING ROUND(price, 2);
```

### 5. ENUM Type Changes

```sql
-- Create new enum type first
CREATE TYPE new_status AS ENUM ('draft', 'published', 'archived');

-- Cast through text intermediate type
ALTER TABLE t ALTER COLUMN status TYPE new_status
  USING status::text::new_status;

-- Clean up old type
DROP TYPE old_status;
```

### 6. NOT NULL Changes (Separate Operation)

```sql
-- These are independent operations
ALTER TABLE t ALTER COLUMN name TYPE varchar(100);        -- Type change
ALTER TABLE t ALTER COLUMN name SET NOT NULL;            -- Nullability change
```

### 7. DEFAULT Changes (Separate Operation)

```sql
-- Also independent
ALTER TABLE t ALTER COLUMN created TYPE timestamptz;                -- Type change
ALTER TABLE t ALTER COLUMN created SET DEFAULT CURRENT_TIMESTAMP;   -- Default change
```

### 8. Generated Columns

Cannot alter the generation expression - must drop and recreate:

```sql
-- Can't alter expression, must recreate
ALTER TABLE t DROP COLUMN full_name;
ALTER TABLE t ADD COLUMN full_name text
  GENERATED ALWAYS AS (first_name || ' ' || last_name) STORED;
```

### 9. Narrowing Conversions (Data Loss Risk)

These may fail or truncate data:

```sql
-- May fail if existing data too long
ALTER TABLE t ALTER COLUMN name TYPE varchar(50);  -- was varchar(100)

-- Loses decimal precision
ALTER TABLE t ALTER COLUMN price TYPE numeric(10,2);  -- was numeric(10,4)

-- May overflow
ALTER TABLE t ALTER COLUMN count TYPE integer;  -- was bigint
```

### 10. Collation Changes

Must be part of the type change:

```sql
ALTER TABLE t ALTER COLUMN name TYPE text COLLATE "en_US";
```
