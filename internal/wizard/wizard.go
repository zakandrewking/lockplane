package wizard

import (
	"fmt"
	"os"
	"strings"

	tea "github.com/charmbracelet/bubbletea"
)

type WizardState int

const (
	StateStart WizardState = iota
	StateCreateSucceeded
	StateCreateFailed
)

type wizardModel struct {
	state    WizardState
	finalErr error
	force    bool
}

func initialModel(force bool) wizardModel {
	return wizardModel{
		state: StateStart,
		force: force,
	}
}

func (m wizardModel) Init() tea.Cmd {
	return nil
}

// commands
type fileCreationResultMsg struct {
	err error
}

func writeDefaultInit(force bool) tea.Cmd {
	return func() tea.Msg {
		configPath := "lockplane.toml"
		if !force {
			if _, err := os.Stat(configPath); err == nil {
				return fileCreationResultMsg{err: fmt.Errorf("file lockplane.toml already exists. Use `lockplane init --force` to overwrite")}
			}
		}
		var b strings.Builder
		b.WriteString("# Generated by: lockplane init\n")
		b.WriteString("#\n")
		b.WriteString("[environments.local]\n")
		b.WriteString("postgres_url = \"postgresql://postgres:postgres@localhost:5432/postgres\"\n")
		err := os.WriteFile(configPath, []byte(b.String()), 0600)
		return fileCreationResultMsg{err: err}
	}
}

// update
func (m wizardModel) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
	switch msg := msg.(type) {
	case tea.KeyMsg:
		switch msg.String() {
		case "enter":
			return m.handleEnter()
		default:
			return m, tea.Quit
		}
	case fileCreationResultMsg:
		switch msg.err {
		case nil:
			m.state = StateCreateSucceeded
		default:
			m.state = StateCreateFailed
			m.finalErr = msg.err
		}
		return m, tea.Quit
	}
	return m, nil
}

func (m wizardModel) handleEnter() (tea.Model, tea.Cmd) {
	switch m.state {
	case StateStart:
		return m, writeDefaultInit(m.force)
	}
	return m, nil
}

// render
func getResult(m wizardModel) (string, error) {
	switch m.state {
	case StateCreateFailed:
		return "Could not create the file", m.finalErr
	case StateCreateSucceeded:
		return "File created", nil
	default:
		return "", nil
	}
}

func (m wizardModel) View() string {
	switch m.state {
	case StateStart:
		return "Press Enter to create a lockplane.toml in this directory."
	default:
		res, _ := getResult(m)
		return res
	}
}

func Run(force bool) error {
	p := tea.NewProgram(initialModel(force))
	m, err := p.Run()
	if err != nil {
		return err
	}
	if wm, ok := m.(wizardModel); ok {
		res, err := getResult(wm)
		if res != "" {
			_, _ = fmt.Println(res)
		}
		return err
	} else {
		return fmt.Errorf("unexpected model type")
	}
}
