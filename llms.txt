# Lockplane

> Safe database schema management with shadow DB testing

Define your database schema in `.lp.sql` files, validate them, and apply changes safely.

## Quick Start

1. **Create schema** in `.lp.sql` files (standard PostgreSQL DDL)
2. **Validate**: `lockplane plan --validate schema/`
3. **Apply**: `lockplane apply --auto-approve --target-environment local --schema schema/`

## Commands

### Validate schema
```bash
lockplane plan --validate schema/users.lp.sql
lockplane plan --validate schema/  # validate entire directory
```

### Apply changes
```bash
# Configure environments in lockplane.toml and .env.<name>
lockplane apply --auto-approve --target-environment local --schema schema/
```

## Schema Format

Use standard PostgreSQL DDL in `.lp.sql` files:

```sql
-- schema/users.lp.sql
CREATE TABLE users (
  id BIGINT PRIMARY KEY,
  email TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE UNIQUE INDEX users_email_idx ON users(email);
```

**Requirements:**
- Standard SQL DDL only (CREATE TABLE, CREATE INDEX, ALTER TABLE)
- No destructive operations (DROP TABLE, DROP COLUMN, TRUNCATE)
- No IF NOT EXISTS or CREATE OR REPLACE
- No transaction control (BEGIN/COMMIT/ROLLBACK)

## Safety Features

**Shadow DB Testing**: All migrations are tested on a shadow database first, so bad changes never touch production.

**Breaking Change Detection**: Lockplane automatically classifies every migration operation by safety level:
- âœ… **Safe** - Fully reversible, no data loss (e.g., adding nullable column)
- âš ï¸ **Review** - May need review for performance (e.g., adding index on large table)
- ðŸ”¶ **Lossy** - Safe forward, but rollback may lose data (e.g., INTEGER â†’ BIGINT)
- âŒ **Dangerous** - Permanent data loss or breaking change (e.g., dropping column, BIGINT â†’ INTEGER)
- ðŸ”„ **Multi-Phase** - Requires coordinated application changes

**Migration Safety Analysis**:
- Detects permanent data loss (dropping columns/tables)
- Analyzes type conversion safety (widening vs narrowing)
- Identifies rollback risks and warns about irreversible operations
- Suggests safer alternatives for dangerous operations (e.g., expand/contract pattern)

**Dangerous Pattern Detection**: Lockplane validates SQL and rejects:
- Data loss operations in schema files (DROP TABLE, DROP COLUMN, TRUNCATE)
- Non-declarative patterns (IF NOT EXISTS, transaction control)
- Warns about blocking operations (CREATE INDEX without CONCURRENTLY)

## Example Workflow

```bash
# 1. Create schema file
cat > schema/users.lp.sql <<EOF
CREATE TABLE users (
  id BIGINT PRIMARY KEY,
  email TEXT NOT NULL
);
EOF

# 2. Validate
lockplane plan --validate schema/

# 3. Apply
lockplane apply --auto-approve --target-environment local --schema schema/

# 4. Make a change (add column)
# Edit schema/users.lp.sql to add: age INTEGER NOT NULL DEFAULT 0

# 5. Apply again
lockplane apply --auto-approve --target-environment local --schema schema/
```

## Configuration

Define environments in lockplane.toml and keep credentials in `.env.<name>` files:

```toml
default_environment = "local"

[environments.local]
description = "Local development"
```

```bash
# .env.local - PostgreSQL
DATABASE_URL=postgresql://user:password@localhost:5432/myapp?sslmode=disable
SHADOW_DATABASE_URL=postgresql://user:password@localhost:5433/myapp_shadow?sslmode=disable

# Or for Turso:
# DATABASE_URL=libsql://mydb-user.turso.io?authToken=eyJhbGc...
# SHADOW_DATABASE_URL=libsql://mydb-shadow-user.turso.io?authToken=eyJhbGc...
```

**Supported databases:** PostgreSQL, SQLite, Turso/libSQL

Override with CLI flags `--target`, `--shadow-db`, `--from`, and `--from-environment` when needed.

---

Project: https://github.com/zakandrewking/lockplane
