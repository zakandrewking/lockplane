# Claude Code Instructions for Lockplane

## Project Overview

Lockplane is a Postgres-first control plane for safe, AI-friendly schema management. It provides:
- Schema introspection and diff generation
- Migration plan generation with validation
- Shadow DB testing before production deployment
- Automatic rollback generation

## üö® COMPLETE WORKFLOW CHECKLIST üö®

**WHENEVER YOU MAKE CODE CHANGES, FOLLOW THIS CHECKLIST EXACTLY:**

### Phase 1: Planning & Implementation
- [ ] Understand the requirement fully
- [ ] Identify which files need to be modified
- [ ] Make code changes
- [ ] Format code with `gofmt` if needed

### Phase 2: Testing
- [ ] Write or update tests for the changes
- [ ] Run tests: `go test -v ./...`
- [ ] Verify tests pass
- [ ] Build the project: `go build .`
- [ ] Verify build succeeds

### Phase 3: Documentation (CRITICAL - DO NOT SKIP)
- [ ] Update `printHelp()` in `main.go` if CLI changed
- [ ] Update `README.md` with examples and usage
- [ ] Update `docs/getting_started.md` with user workflows
- [ ] Check if `docs/prisma.md` needs updates
- [ ] Check if `docs/supabase.md` needs updates
- [ ] Check if `docs/alembic.md` needs updates
- [ ] Update any other relevant docs in `docs/` directory

### Phase 4: Git (CRITICAL - ALWAYS COMMIT AND PUSH)
- [ ] Check git status: `git status`
- [ ] Review changes: `git diff`
- [ ] Stage all changes: `git add .`
- [ ] Create descriptive commit message following this format:
  ```
  <type>: <short description>

  <longer description if needed>
  - Detail 1
  - Detail 2
  ```
  Types: `feat`, `fix`, `docs`, `refactor`, `test`, `chore`
- [ ] Commit changes: `git commit -m "message"`
- [ ] Push to remote: `git push`

### Phase 5: Verification
- [ ] Verify commit was successful: `git log -1`
- [ ] Verify push was successful: `git status` should show "up to date"
- [ ] Summarize what was done for the user

**REMEMBER: Code changes without documentation updates and git commits are incomplete work!**

## Code Organization

- `main.go` - CLI entry point and command handlers
- `planner.go` - Migration plan generation
- `rollback.go` - Rollback plan generation
- `diff.go` - Schema diffing logic
- `json_schema.go` - JSON schema loading and validation
- `init.go` - Docker Compose setup
- `docs/` - Documentation files
- `examples/` - Example schemas and plans
- `testdata/` - Test fixtures

## Development Workflow

### When Adding New Features or Changing Behavior

**ALWAYS FOLLOW THE CHECKLIST ABOVE - NO EXCEPTIONS**

The checklist ensures:
1. Code quality through testing
2. User experience through documentation
3. Version control through git commits
4. Team collaboration through git push

**Common mistake:** Making code changes and forgetting to update docs or commit. This leaves the repository in an inconsistent state.

### Documentation Files to Check

When making changes to CLI commands or workflows:
- [ ] `README.md` - Main documentation with examples
- [ ] `docs/getting_started.md` - Step-by-step guide for new users
- [ ] `main.go` - `printHelp()` function
- [ ] `docs/prisma.md` - If relevant to Prisma integration
- [ ] `docs/supabase.md` - If relevant to Supabase integration
- [ ] `docs/alembic.md` - If relevant to Alembic integration

### Testing

- Run all tests: `go test -v ./...`
- Run specific test: `go test -v -run TestName`
- Check test coverage: `go test -cover ./...`

### Building

```bash
go build .
./lockplane version
```

### Code Style

- Use `gofmt` for formatting
- Keep functions focused and single-purpose
- Add comments for exported functions
- Use descriptive variable names

## Common Tasks

### Adding a New CLI Flag

1. Add the flag in the relevant `run*()` function using `flag.NewFlagSet()`
2. Update the usage message in that function
3. Update `printHelp()` in `main.go`
4. Add example in `README.md`
5. Add example in `docs/getting_started.md`

### Adding a New Command

1. Add case in `main()` switch statement
2. Create `run*()` handler function
3. Update `printHelp()` function
4. Add documentation in README.md
5. Add workflow examples in docs/getting_started.md
6. Write tests

### Modifying Migration Logic

1. Update the relevant planner/rollback/diff file
2. Add or update tests
3. Check if examples need updating
4. Document any breaking changes

## Schema Format

Lockplane uses JSON Schema for validation. Schema files reference:
- `https://raw.githubusercontent.com/zakandrewking/lockplane/main/schema-json/schema.json`
- Replace `main` with version tags (e.g., `v0.1.0`) for stability

## Important Principles

1. **Schema is the source of truth** - Migration plans are generated on demand
2. **Shadow DB validation** - Always test migrations before production
3. **Reversibility** - Every forward migration should have a rollback
4. **Explainability** - Every operation should have a clear description
5. **Safety** - Validate migrations before execution

## Documentation Standards

- Use clear, concise language
- Provide working examples
- Show both success and error cases
- Include environment variable requirements
- Document all CLI flags and options
- Keep examples up to date with code changes

## Remember

**THE COMPLETE WORKFLOW CHECKLIST AT THE TOP IS MANDATORY**

This is not optional. The checklist ensures:

1. **Documentation stays in sync** - Users can trust the docs match the code
2. **Tests prevent regressions** - Changes don't break existing functionality
3. **Git history is complete** - All work is tracked and shareable
4. **Remote stays updated** - Team members can see the latest changes

**Incomplete work is:**
- ‚ùå Code changes without tests
- ‚ùå Code changes without documentation updates
- ‚ùå Code changes without git commit
- ‚ùå Git commits without git push
- ‚ùå Skipping any step in the checklist

**Complete work is:**
- ‚úÖ All checklist items completed
- ‚úÖ Tests pass
- ‚úÖ Documentation updated
- ‚úÖ Changes committed and pushed
- ‚úÖ User informed of what was done
