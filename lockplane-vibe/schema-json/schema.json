{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://lockplane.dev/schema.json",
  "title": "Lockplane Database Schema",
  "description": "Defines the structure of a database schema with tables, columns, and indexes",
  "type": "object",
  "required": ["tables"],
  "additionalProperties": false,
  "properties": {
    "tables": {
      "type": "array",
      "description": "List of database tables",
      "items": {
        "$ref": "#/definitions/Table"
      }
    },
    "dialect": {
      "type": "string",
      "enum": ["postgres", "sqlite", ""],
      "description": "Database dialect (postgres, sqlite, or empty for unknown). Optional field used by introspection."
    }
  },
  "definitions": {
    "Table": {
      "type": "object",
      "required": ["name", "columns"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z_][a-z0-9_]*$",
          "description": "Table name in snake_case"
        },
        "columns": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/Column"
          },
          "description": "List of table columns"
        },
        "indexes": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/Index"
          },
          "description": "List of table indexes"
        },
        "foreign_keys": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/ForeignKey"
          },
          "description": "List of foreign key constraints"
        }
      }
    },
    "Column": {
      "type": "object",
      "required": ["name", "type", "nullable", "is_primary_key"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z_][a-z0-9_]*$",
          "description": "Column name in snake_case"
        },
        "type": {
          "type": "string",
          "description": "PostgreSQL column type (e.g., text, integer, timestamp)"
        },
        "nullable": {
          "type": "boolean",
          "description": "Whether the column allows NULL values"
        },
        "default": {
          "type": "string",
          "description": "Default value expression"
        },
        "is_primary_key": {
          "type": "boolean",
          "description": "Whether this column is part of the primary key"
        },
        "type_metadata": {
          "$ref": "#/definitions/TypeMetadata",
          "description": "Optional metadata about the column type (logical vs raw type representation)"
        },
        "default_metadata": {
          "$ref": "#/definitions/DefaultMetadata",
          "description": "Optional metadata about the default value expression"
        }
      }
    },
    "Index": {
      "type": "object",
      "required": ["name", "columns", "unique"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z_][a-z0-9_]*$",
          "description": "Index name in snake_case"
        },
        "columns": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "List of column names in the index"
        },
        "unique": {
          "type": "boolean",
          "description": "Whether this is a unique index"
        }
      }
    },
    "ForeignKey": {
      "type": "object",
      "required": ["name", "columns", "referenced_table", "referenced_columns"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "pattern": "^[a-z_][a-z0-9_]*$",
          "description": "Foreign key constraint name in snake_case"
        },
        "columns": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "Local column names that reference the foreign table"
        },
        "referenced_table": {
          "type": "string",
          "description": "Name of the referenced table (can include schema, e.g., 'auth.users')"
        },
        "referenced_columns": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "Column names in the referenced table"
        },
        "on_delete": {
          "type": "string",
          "enum": ["NO ACTION", "RESTRICT", "CASCADE", "SET NULL", "SET DEFAULT"],
          "description": "Action to take when referenced row is deleted"
        },
        "on_update": {
          "type": "string",
          "enum": ["NO ACTION", "RESTRICT", "CASCADE", "SET NULL", "SET DEFAULT"],
          "description": "Action to take when referenced row is updated"
        }
      }
    },
    "TypeMetadata": {
      "type": "object",
      "additionalProperties": false,
      "description": "Metadata about a column's type representation. Captures both logical (normalized) and raw (database-specific) type information.",
      "properties": {
        "logical": {
          "type": "string",
          "description": "Normalized type name used for cross-database comparisons (e.g., 'integer', 'text')"
        },
        "raw": {
          "type": "string",
          "description": "Database-specific raw type (e.g., 'pg_catalog.int4', 'INTEGER', 'character varying(255)')"
        },
        "dialect": {
          "type": "string",
          "enum": ["postgres", "sqlite", ""],
          "description": "Database dialect this type metadata comes from"
        }
      }
    },
    "DefaultMetadata": {
      "type": "object",
      "additionalProperties": false,
      "description": "Metadata about a column's default value expression. Captures raw database-specific default expressions.",
      "properties": {
        "raw": {
          "type": "string",
          "description": "Raw default expression as returned by the database (e.g., 'nextval(\\'users_id_seq\\'::regclass)', 'CURRENT_TIMESTAMP')"
        },
        "dialect": {
          "type": "string",
          "enum": ["postgres", "sqlite", ""],
          "description": "Database dialect this default metadata comes from"
        },
        "kind": {
          "type": "string",
          "description": "Kind of default expression (e.g., 'sequence', 'function', 'literal')"
        }
      }
    }
  }
}
