{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://lockplane.dev/plan.json",
  "title": "Lockplane Migration Plan",
  "description": "A migration plan containing steps to migrate from one schema version to another. Each step represents a single logical operation that may consist of multiple SQL statements executed atomically.",
  "type": "object",
  "required": ["steps"],
  "properties": {
    "source_hash": {
      "type": "string",
      "pattern": "^[a-f0-9]{64}$",
      "description": "SHA-256 hash of the source database schema. Used to verify the plan is being applied to the correct database state."
    },
    "steps": {
      "type": "array",
      "minItems": 1,
      "items": {
        "$ref": "#/definitions/PlanStep"
      },
      "description": "Array of migration steps. Each step is executed atomically within a transaction."
    }
  },
  "definitions": {
    "PlanStep": {
      "type": "object",
      "required": ["description", "sql"],
      "description": "A single logical migration operation. For operations that require multiple SQL statements (e.g., SQLite table recreation), all statements are included in the sql array and executed atomically.",
      "properties": {
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "Human-readable description of what this step does"
        },
        "sql": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          },
          "description": "Array of SQL statements to execute for this step. All statements are executed in order within the same transaction. If any statement fails, the entire step (and transaction) is rolled back."
        }
      }
    }
  }
}
